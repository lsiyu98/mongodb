<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›²ç§‘å¤§æ ¡åœ’é»é¤ç³»çµ±-ç®¡ç†å“¡ç«¯ </title>
    <!-- å°å…¥ Tailwind CSS CDN -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¨­ç½® Inter å­—é«”ç‚ºé è¨­å­—é«” -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        /* ä¸»è¦å¡ç‰‡å®¹å™¨ï¼Œç¢ºä¿é«˜åº¦ */
        .main-card {
            min-height: 80vh;
            display: flex;
            flex-direction: column;
        }
        /* è®“ Chat Box å’Œ Announcement Box æœ‰å›ºå®šé«˜åº¦å’Œç¾è§€çš„æ»¾å‹•æ¢ */
        .scroll-box {
            overflow-y: auto;
            border-radius: 0.5rem;
            background-color: white;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        /* èŠå¤©ç´€éŒ„å°ˆç”¨æ»¾å‹•å€ */
        .chat-scroll-box {
            height: 400px; /* èŠå¤©è¨˜éŒ„å›ºå®šé«˜åº¦ */
            padding: 1rem;
        }
        /* å…¬å‘Šå°ˆç”¨æ»¾å‹•å€ */
        .announcement-scroll-box {
            height: 485px; /* é…åˆèŠå¤©å€é«˜åº¦èª¿æ•´ */
            border: 1px solid #e0e0e0;
            padding: 1rem;
        }
        /* ç‹€æ…‹ç‡ˆè™Ÿ */
        .status-dot {
            height: 10px;
            width: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 0.5rem;
        }
        .status-dot.connected { background-color: #10b981; } /* ç¶ è‰² */
        .status-dot.disconnected { background-color: #ef4444; } /* ç´…è‰² */
    </style>
</head>
<body>
    <div class="w-full max-w-6xl p-6 bg-white shadow-2xl rounded-xl main-card">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6 border-b-2 pb-3">
            <main>é›²ç§‘å¤§æ ¡åœ’é»é¤ç³»çµ±-ç®¡ç†å“¡ç«¯</main>
        </h1>
        
        <!-- èº«ä»½é¸æ“‡èˆ‡é€£ç·šç‹€æ…‹ -->
        <div class="p-4 bg-indigo-50 rounded-lg shadow-sm mb-6 flex flex-col sm:flex-row items-start sm:items-center justify-between space-y-3 sm:space-y-0">
            <div class="role-selector flex flex-wrap gap-x-6 gap-y-2 items-center">
                <label class="font-semibold text-indigo-700">é¸æ“‡èº«ä»½ï¼š</label>
                <div class="flex items-center space-x-4">
                    <input type="radio" id="student" name="role" value="student" class="text-indigo-600 focus:ring-indigo-500" checked> 
                    <label for="student" class="text-sm text-gray-700">å­¸ç”Ÿ (user101)</label>
                    <input type="radio" id="store" name="role" value="store" class="text-indigo-600 focus:ring-indigo-500"> 
                    <label for="store" class="text-sm text-gray-700">åº—å®¶ (store202)</label>
                    <input type="radio" id="admin" name="role" value="admin" class="text-indigo-600 focus:ring-indigo-500"> 
                    <label for="admin" class="text-sm text-gray-700">ç®¡ç†å“¡ (admin001)</label>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <button id="connectBtn" class="px-4 py-2 bg-indigo-600 text-white font-medium rounded-lg hover:bg-indigo-700 transition duration-150 shadow-md">
                    é€£ç·š
                </button>
                <p class="text-sm font-medium text-gray-700">
                    ç‹€æ…‹: 
                    <!-- æ³¨æ„ï¼šé€™è£¡çš„åˆå§‹ç‹€æ…‹æ²’æœ‰é¡è‰²é¡åˆ¥ï¼Œäº¤ç”± JS è™•ç† -->
                    <span id="status" class="font-bold">
                        <span class="status-dot disconnected"></span>æœªé€£ç·š
                    </span>
                </p>
            </div>
        </div>

        <!-- ä¸»å…§å®¹å€å¡Š (åŒ…å«èŠå¤©å’Œå…¬å‘Š) -->
        <div class="flex-grow grid grid-cols-1 xl:grid-cols-3 gap-6">

            <!-- èŠå¤©å€ (å…©æ¬„çµæ§‹ï¼šè¯ç¹«äººåˆ—è¡¨ + å°è©±æ¡†) -->
            <div id="chat-container" class="xl:col-span-2 flex flex-col bg-white rounded-xl shadow-lg border">
                <div class="grid grid-cols-1 sm:grid-cols-3 flex-grow min-h-[500px]">
                    <!-- å·¦å´ï¼šè¯ç¹«äººåˆ—è¡¨ -->
                    <div class="sm:col-span-1 border-r border-gray-200 bg-gray-50 flex flex-col">
                        <div class="p-3 bg-gray-100 border-b border-gray-200">
                            <h2 class="text-lg font-semibold text-gray-700">è¯ç¹«äºº</h2>
                        </div>
                        <div id="contactList" class="flex-grow overflow-y-auto">
                            <!-- è¯ç¹«äººåˆ—è¡¨å°‡æ¸²æŸ“åœ¨é€™è£¡ -->
                        </div>
                    </div>

                    <!-- å³å´ï¼šå°è©±è¦–çª— -->
                    <div class="sm:col-span-2 flex flex-col">
                        <div class="p-3 bg-blue-100 border-b border-gray-200">
                            <h2 id="chatHeader" class="text-lg font-bold text-blue-800">
                                è«‹å…ˆé¸æ“‡è¯ç¹«äººä¸¦é»æ“Šé€£ç·š
                            </h2>
                        </div>
                        
                        <!-- è¨Šæ¯é¡¯ç¤ºå€ -->
                        <div id="chatMessages" class="chat-scroll-box flex-grow">
                            <!-- èŠå¤©è¨Šæ¯å°‡é¡¯ç¤ºåœ¨é€™è£¡ -->
                        </div>
                        
                        <!-- è¼¸å…¥æ¡† -->
                        <div class="p-3 border-t border-gray-200 bg-white">
                            <div class="flex space-x-2">
                                <input type="text" id="chatInput" placeholder="è¼¸å…¥èŠå¤©è¨Šæ¯..."
                                       class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 disabled:bg-gray-100" 
                                       disabled />
                                <button id="sendChatBtn" class="px-5 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition duration-150 shadow-md disabled:bg-gray-400" disabled>
                                    ç™¼é€
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å³å´ï¼šå…¬å‘Šèˆ‡è¨‚å–®å€å¡Š -->
            <div class="xl:col-span-1 flex flex-col">
                <!-- å…¬å‘Šç™¼ä½ˆé¢æ¿ (åƒ…é™ Store/Admin) -->
                <div id="broadcastPanel" class="p-4 bg-yellow-50 border border-yellow-300 rounded-lg shadow-inner mb-4" style="display:none;">
                    <h2 class="text-lg font-semibold text-yellow-800 mb-2 border-b border-yellow-300 pb-1">ğŸ“¢ å…¬å‘Šç™¼ä½ˆ</h2>
                    <p id="broadcastRoleStatus" class="font-medium text-yellow-700 mb-3 text-sm">ç›®å‰èº«ä»½: </p>
                    <div class="flex flex-col space-y-2">
                        <select id="targetRole" class="p-2 border border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500">
                            <option value="all">æ¨æ’­çµ¦æ‰€æœ‰äºº</option>
                            <option value="student">æ¨æ’­çµ¦æ‰€æœ‰å­¸ç”Ÿ</option>
                            <option value="store">æ¨æ’­çµ¦æ‰€æœ‰åº—å®¶</option>
                            <option value="admin">æ¨æ’­çµ¦æ‰€æœ‰ç®¡ç†å“¡</option>
                        </select>
                        <input type="text" id="announcementInput" placeholder="è¼¸å…¥å…¬å‘Šè¨Šæ¯" 
                               class="p-2 border border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500" />
                        <button id="broadcastBtn" class="px-4 py-2 bg-yellow-600 text-white font-medium rounded-lg hover:bg-yellow-700 transition duration-150 shadow-md">
                            ç™¼ä½ˆå…¬å‘Š
                        </button>
                    </div>
                </div>

                <!-- è¨‚å–®ç‹€æ…‹æ¨¡æ“¬æŒ‰éˆ• -->
                <div class="p-4 bg-indigo-100 rounded-lg shadow-inner mb-4" id="orderSimulation" style="display:none;">
                    <p class="font-medium text-indigo-800 mb-2">ğŸ“¦ è¨‚å–®ç‹€æ…‹æ¨¡æ“¬</p>
                    <div class="flex flex-wrap gap-2 items-center">
                        <span class="text-sm">è¨‚å–®#</span>
                        <input type="number" id="orderIdInput" value="1" min="1" class="w-12 p-1 border rounded-lg text-center text-sm" />
                        <select id="newStatusSelect" class="p-1 border rounded-lg text-sm">
                            <option value="Preparing">è£½ä½œä¸­</option>
                            <option value="Ready">å¯å–é¤</option>
                            <option value="Delivered">å·²äº¤ä»˜</option>
                        </select>
                        <button id="updateStatusBtn" class="px-3 py-1 bg-indigo-600 text-white text-sm rounded-lg hover:bg-indigo-700 transition duration-150">
                            æ›´æ–°
                        </button>
                    </div>
                </div>

                <!-- å…¬å‘Šæ¨æ’­è¨Šæ¯å€ -->
                <div class="flex-grow bg-gray-50 p-4 rounded-xl shadow-lg border">
                    <h2 class="text-lg font-semibold text-gray-700 mb-3 border-b pb-2">ğŸ”” æ¨æ’­è¨Šæ¯ç´€éŒ„</h2>
                    <div id="announcementMessages" class="announcement-scroll-box scroll-box">
                        <!-- å…¬å‘Šå’Œè¨‚å–®æ¨æ’­è¨Šæ¯å°‡é¡¯ç¤ºåœ¨é€™è£¡ -->
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- è…³æœ¬å€åŸŸ -->
    <script>
        const API_SERVER_URL = 'http://localhost:3001';
        let socket;
        let currentUserId = 'user101';
        let currentUserRole = 'student';
        let currentPeerId = ''; // **æ ¸å¿ƒè®Šé‡**ï¼šç›®å‰é¸ä¸­çš„å°è©±å°è±¡ ID
        
        let chatHistory = {}; // Key: å°æ–¹ID (peerId)ï¼ŒValue: è©²å°è©±çš„è¨Šæ¯é™£åˆ—
        let systemHistory = []; // ç¨ç«‹å­˜æ”¾ç³»çµ±è¨Šæ¯

        // é è¨­è¯ç¹«äººåˆ—è¡¨ (ç³»çµ±å…§æ‰€æœ‰ç”¨æˆ¶ ID)
        const PEERS = {
            'user101': 'å­¸ç”Ÿ-å¼µä¸‰',
            'store202': 'åº—å®¶-æå››',
            'admin001': 'ç®¡ç†å“¡-ç‹äº”',
        };
        const PEER_ROLES = {
            'user101': 'student',
            'store202': 'store',
            'admin001': 'admin',
        };

        // --- DOM å…ƒç´ å¿«å– ---
        const statusEl = document.getElementById('status');
        const connectBtn = document.getElementById('connectBtn');
        const broadcastPanel = document.getElementById('broadcastPanel');
        const broadcastRoleStatus = document.getElementById('broadcastRoleStatus');
        const targetRoleSelect = document.getElementById('targetRole');
        const announcementInput = document.getElementById('announcementInput');
        const broadcastBtn = document.getElementById('broadcastBtn');
        const chatInput = document.getElementById('chatInput');
        const sendChatBtn = document.getElementById('sendChatBtn');
        const chatMessagesEl = document.getElementById('chatMessages');
        const chatHeaderEl = document.getElementById('chatHeader');
        const contactListEl = document.getElementById('contactList');
        const announcementMessagesEl = document.getElementById('announcementMessages');
        const orderSimulationEl = document.getElementById('orderSimulation');
        const updateStatusBtn = document.getElementById('updateStatusBtn');
        const orderIdInput = document.getElementById('orderIdInput');
        const newStatusSelect = document.getElementById('newStatusSelect');

        // --- è¼”åŠ©å‡½æ•¸ ---
        
        /**
         * æ ¼å¼åŒ–æ™‚é–“æˆ³
         */
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
        }

        /**
         * æ¸²æŸ“å–®ä¸€è¨Šæ¯åˆ° DOM
         */
        function _renderSingleMessage(data) {
            const { senderId, message, timestamp, isSystem } = data;
            const time = formatTime(timestamp);
            const isSelf = senderId === currentUserId && !isSystem;

            let messageClass = '';
            let alignmentClass = '';
            let nameDisplay = isSystem ? 'ç³»çµ±' : (PEERS[senderId] || senderId);

            if (isSystem) {
                messageClass = 'text-gray-500 bg-gray-100 italic text-center';
                alignmentClass = 'justify-center';
            } else if (isSelf) {
                messageClass = 'bg-blue-500 text-white self-end';
                alignmentClass = 'justify-end';
            } else {
                messageClass = 'bg-white text-gray-800 border border-gray-200 shadow-sm self-start';
                alignmentClass = 'justify-start';
                nameDisplay = `<span class="font-medium text-sm text-gray-600">${nameDisplay}</span>`;
            }

            const messageHtml = `
                <div class="flex ${alignmentClass} my-2">
                    <div class="max-w-[80%] p-3 rounded-xl ${messageClass}">
                        ${!isSelf && !isSystem ? `<div class="mb-1">${nameDisplay}</div>` : ''}
                        <p class="text-sm">${message}</p>
                        <div class="text-xs mt-1 ${isSelf ? 'text-blue-200' : 'text-gray-400'} text-right">${time}</div>
                    </div>
                </div>
            `;
            chatMessagesEl.innerHTML += messageHtml;
        }

        /**
         * æ ¸å¿ƒåŠŸèƒ½ï¼šæ ¹æ“šç•¶å‰é¸ä¸­çš„è¯ç¹«äººIDæ¸²æŸ“å°è©±æ¡†
         */
        function renderCurrentChat() {
            chatMessagesEl.innerHTML = ''; // æ¸…ç©ºèŠå¤©è¦–çª—

            const peerId = currentPeerId;

            if (!peerId) {
                chatMessagesEl.innerHTML = `
                    <div class="text-center text-gray-400 italic py-4">
                        è«‹é»æ“Šå·¦å´è¯ç¹«äººåˆ—è¡¨é–‹å§‹å°è©±...
                    </div>
                `;
                chatHeaderEl.textContent = 'è«‹é¸æ“‡è¯ç¹«äºº';
                return;
            }

            // ç³»çµ±è¨Šæ¯æœ‰ç¨ç«‹æ­·å²è¨˜éŒ„
            const messages = peerId === 'System' ? systemHistory : chatHistory[peerId] || [];
            const peerName = peerId === 'System' ? 'ç³»çµ±è¨Šæ¯' : (PEERS[peerId] || peerId);

            chatHeaderEl.textContent = `èˆ‡ ${peerName} (${peerId}) çš„å°è©±`;

            if (messages.length === 0) {
                chatMessagesEl.innerHTML = `
                    <div class="text-center text-gray-400 italic py-4">
                        ${peerId === 'System' ? 'é€£ç·šæˆåŠŸï¼Œç³»çµ±è¨Šæ¯å°‡æœƒå‡ºç¾åœ¨é€™è£¡ã€‚' : `èˆ‡ ${peerName} çš„æ–°å°è©±é–‹å§‹...`}
                    </div>
                `;
                return;
            }

            // æ¸²æŸ“æ‰€æœ‰æ­·å²è¨Šæ¯
            messages.forEach(data => {
                _renderSingleMessage(data); 
            });
            chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
        }
        
        /**
         * æ¸²æŸ“è¯ç¹«äººåˆ—è¡¨
         */
        function renderContactList() {
            contactListEl.innerHTML = '';
            // éæ¿¾æ‰è‡ªå·±ï¼Œç”Ÿæˆè¯ç¹«äººåˆ—è¡¨
            const allPeers = Object.keys(PEERS).filter(id => id !== currentUserId);

            // 1. å§‹çµ‚å°‡ "ç³»çµ±è¨Šæ¯" æ”¾åœ¨æœ€é ‚ç«¯
            const systemPeerId = 'System';
            const systemEl = createContactItem(systemPeerId, 'ç³»çµ±è¨Šæ¯', systemPeerId === currentPeerId);
            contactListEl.appendChild(systemEl);

            // 2. æ¸²æŸ“å…¶ä»–ç”¨æˆ¶
            allPeers.forEach(peerId => {
                const peerName = PEERS[peerId];
                const isActive = peerId === currentPeerId;
                const item = createContactItem(peerId, peerName, isActive);
                contactListEl.appendChild(item);
            });
        }

        /**
         * å‰µå»ºå–®å€‹è¯ç¹«äººåˆ—è¡¨é …çš„ DOM å…ƒç´ 
         */
        function createContactItem(peerId, peerName, isActive) {
            const li = document.createElement('div');
            li.className = `p-3 cursor-pointer border-b border-gray-100 transition duration-150 ${isActive ? 'bg-blue-200 hover:bg-blue-300' : 'hover:bg-gray-100'}`;
            li.innerHTML = `
                <div class="font-semibold text-gray-800">${peerName}</div>
                <div class="text-xs text-gray-500">${peerId}</div>
            `;
            li.setAttribute('data-peer-id', peerId);
            li.addEventListener('click', () => selectPeer(peerId));
            return li;
        }

        /**
         * é¸æ“‡æ–°çš„å°è©±å°è±¡
         * @param {string} peerId - è¢«é¸ä¸­çš„è¯ç¹«äºº ID
         */
        function selectPeer(peerId) {
            // å¦‚æœé€£ç·šå°šæœªå»ºç«‹ï¼Œä½† peerId æ˜¯æœ‰æ•ˆçš„ï¼Œæˆ‘å€‘ä»ç„¶å…è¨±è¨­ç½® currentPeerId
            // ä½†å¦‚æœé¸ä¸­ç›¸åŒçš„ peerIdï¼Œå‰‡è·³é
            if (peerId !== currentPeerId) {
                 currentPeerId = peerId;
            }

            renderContactList(); // æ›´æ–°åˆ—è¡¨ä¸­çš„é«˜äº®ç‹€æ…‹
            renderCurrentChat(); // è¼‰å…¥æ–°çš„å°è©±æ­·å²
            
            // å¼·åŒ–ï¼šæ ¹æ“šç•¶å‰é€£ç·šç‹€æ…‹å’Œé¸ä¸­å°è±¡ä¾†å•Ÿç”¨/ç¦ç”¨è¼¸å…¥æ¡†
            const isConnected = socket && !socket.disconnected;
            const canSend = isConnected && peerId !== 'System';
            
            chatInput.disabled = !canSend; 
            sendChatBtn.disabled = !canSend;
        }

        /**
         * å°‡è¨Šæ¯æ·»åŠ åˆ°æ­·å²è¨˜éŒ„ä¸­ä¸¦æ±ºå®šæ˜¯å¦æ¸²æŸ“
         */
        function addChatMessage(data) {
            const peerId = data.isSystem ? 'System' : 
                           (data.senderId === currentUserId ? data.receiverId : data.senderId);

            // 1. å­˜å…¥æ­·å²è¨˜éŒ„
            if (data.isSystem) {
                systemHistory.push(data);
            } else {
                if (!chatHistory[peerId]) {
                    chatHistory[peerId] = [];
                }
                chatHistory[peerId].push(data);
            }

            // 2. åˆ¤æ–·æ˜¯å¦éœ€è¦ç«‹å³æ¸²æŸ“
            if (peerId === currentPeerId) {
                renderCurrentChat(); 
            }
        }

        /**
         * å°‡è¨Šæ¯æ·»åŠ åˆ°å…¬å‘Šå€
         */
        function addAnnouncement(title, message, timestamp, type = 'announcement') {
            const time = formatTime(timestamp);
            let icon = 'ğŸ“¢';
            let colorClass = 'bg-green-50 border-green-300 text-green-800';

            if (type === 'order') {
                icon = 'ğŸ“¦';
                colorClass = 'bg-indigo-50 border-indigo-300 text-indigo-800';
            }

            const announcementHtml = `
                <div class="p-3 mb-2 rounded-lg border ${colorClass} shadow-sm">
                    <div class="flex items-center justify-between mb-1">
                        <span class="font-bold text-sm">${icon} ${title}</span>
                        <span class="text-xs text-gray-500">${time}</span>
                    </div>
                    <p class="text-sm">${message}</p>
                </div>
            `;
            announcementMessagesEl.innerHTML += announcementHtml;
            announcementMessagesEl.scrollTop = announcementMessagesEl.scrollHeight;
        }

        /**
         * è¨­ç½®é€£ç·šç‹€æ…‹ (ä¿®æ­£é¡è‰²éŒ¯èª¤å•é¡Œ)
         */
        function setStatus(isConnected) {
            // ä¿®æ­£é»ï¼šç§»é™¤æ‰€æœ‰ç‹€æ…‹å’Œé¡è‰²ç›¸é—œçš„é¡åˆ¥ï¼Œç¢ºä¿ä¸æ®˜ç•™èˆŠçš„é¡è‰²
            statusEl.classList.remove('connected', 'disconnected', 'text-green-600', 'text-red-600');
            
            if (isConnected) {
                // è¨­ç½®é€£ç·šç‹€æ…‹çš„ HTML å’Œç¶ è‰²æ–‡å­—
                statusEl.innerHTML = '<span class="status-dot connected"></span>å·²é€£ç·š';
                statusEl.classList.add('connected', 'text-green-600');
            } else {
                // è¨­ç½®æ–·ç·šç‹€æ…‹çš„ HTML å’Œç´…è‰²æ–‡å­—
                statusEl.innerHTML = '<span class="status-dot disconnected"></span>æœªé€£ç·š';
                statusEl.classList.add('disconnected', 'text-red-600');
            }
            
            // ç¢ºä¿ selectPeer é‚è¼¯è¢«åŸ·è¡Œï¼Œæ›´æ–°ç™¼é€æŒ‰éˆ•ç‹€æ…‹
            selectPeer(currentPeerId || 'System');
        }

        // --- Socket.IO é€£ç·šèˆ‡äº‹ä»¶è™•ç† ---
        
        /**
         * å»ºç«‹ Socket.IO é€£ç·šä¸¦è¨»å†Šç”¨æˆ¶
         */
        function connectAndRegister() {
            if (socket) {
                socket.disconnect();
                console.log('èˆŠé€£ç·šå·²æ–·é–‹');
            }
            
            // **é‡ç½®ç‹€æ…‹**
            chatHistory = {};
            systemHistory = [];

            // æ ¹æ“šé¸ä¸­çš„ Radio ç²å–ç•¶å‰ç”¨æˆ¶è³‡è¨Š
            const selectedRole = document.querySelector('input[name="role"]:checked').value;
            currentUserRole = selectedRole;
            let initialPeerId;

            switch (selectedRole) {
                case 'student':
                    currentUserId = 'user101';
                    initialPeerId = 'store202'; // å­¸ç”Ÿé è¨­å°åº—å®¶
                    break;
                case 'store':
                    currentUserId = 'store202';
                    initialPeerId = 'user101'; // åº—å®¶é è¨­å°å­¸ç”Ÿ
                    break;
                case 'admin':
                    currentUserId = 'admin001';
                    initialPeerId = 'store202'; // ç®¡ç†å“¡é è¨­å°åº—å®¶
                    break;
                default:
                    currentUserId = 'unknown';
                    initialPeerId = 'System';
            }
            
            currentPeerId = initialPeerId; // è¨­å®šåˆå§‹å°è©±å°è±¡ ID
            
            // æ ¹æ“šè§’è‰²é¡¯ç¤ºæˆ–éš±è—é¢æ¿
            updateUIPanels(currentUserRole);

            // å»ºç«‹è¯ç¹«äººåˆ—è¡¨
            renderContactList();
            renderCurrentChat();

            // å»ºç«‹æ–°çš„ Socket.IO é€£ç·š
            socket = io(API_SERVER_URL);

            socket.on('connect', () => {
                console.log('Socket.IO å·²é€£ç·š');
                setStatus(true); 

                // 1. è¨»å†Šç”¨æˆ¶ ID å’Œ è§’è‰²
                socket.emit('register_user', { id: currentUserId, role: currentUserRole });

                // 2. ç³»çµ±é€šçŸ¥
                addChatMessage({
                    senderId: 'System', 
                    message: `æ‚¨å·²ä»¥ [${currentUserRole}] èº«ä»½ (${currentUserId}) æˆåŠŸé€£ç·šä¸¦è¨»å†Šã€‚`, 
                    timestamp: new Date().getTime(), 
                    isSystem: true
                });
            });

            socket.on('disconnect', () => {
                console.log('Socket.IO å·²æ–·é–‹');
                setStatus(false);
                addChatMessage({
                    senderId: 'System', 
                    message: 'é€£ç·šå·²æ–·é–‹ï¼Œè«‹é‡æ–°é€£ç·šã€‚', 
                    timestamp: new Date().getTime(), 
                    isSystem: true
                });
                renderCurrentChat();
            });

            // 3. æ¥æ”¶èŠå¤©è¨Šæ¯
            socket.on('receive_chat_message', (data) => {
                addChatMessage(data);
                if (data.isSystem) {
                     console.error(`ä¼ºæœå™¨ç³»çµ±éŒ¯èª¤: ${data.message}`);
                }
            });

            // 4. æ¥æ”¶å…¬å‘Šè¨Šæ¯
            socket.on('new_announcement', (data) => {
                addAnnouncement('æ–°å…¬å‘Š', `${data.sender}: ${data.message}`, data.timestamp, 'announcement');
            });

            // 5. æ¥æ”¶è¨‚å–®ç‹€æ…‹æ›´æ–°
            socket.on('order_status_update', (data) => {
                const message = `è¨‚å–® #${data.orderId} çš„ç‹€æ…‹å·²ç”± ${data.updater} æ›´æ–°ç‚º: ${data.status}ã€‚`;
                addAnnouncement('è¨‚å–®ç‹€æ…‹æ›´æ–°', message, data.timestamp, 'order');
            });
        }

        /**
         * æ ¹æ“šè§’è‰²æ›´æ–° UI é¢æ¿çš„é¡¯ç¤º
         */
        function updateUIPanels(role) {
            // å»£æ’­é¢æ¿
            if (role === 'store' || role === 'admin') {
                broadcastPanel.style.display = 'block';
                broadcastRoleStatus.textContent = `ç›®å‰èº«ä»½: ${role} (${currentUserId})ï¼Œå¯ç™¼ä½ˆå…¬å‘Šã€‚`;
            } else {
                broadcastPanel.style.display = 'none';
            }

            // è¨‚å–®æ¨¡æ“¬æŒ‰éˆ• (åªæœ‰åº—å®¶èº«ä»½å¯ä»¥çœ‹åˆ°ä¸¦æ“ä½œ)
            if (role === 'store') {
                orderSimulationEl.style.display = 'block';
                updateStatusBtn.textContent = `æ›´æ–°è¨‚å–® #${orderIdInput.value} ç‹€æ…‹`;
            } else {
                orderSimulationEl.style.display = 'none';
            }
        }
        
        // --- äº‹ä»¶ç›£è½å™¨ ---

        // ç›£è½é€£ç·š/é‡æ–°è¨»å†ŠæŒ‰éˆ•
        connectBtn.addEventListener('click', connectAndRegister);

        // ç›£è½è§’è‰²é¸æ“‡è®ŠåŒ–
        document.querySelectorAll('input[name="role"]').forEach(radio => {
            radio.addEventListener('change', () => {
                // æ¸…ç©ºé€£ç·šç‹€æ…‹ï¼Œç­‰å¾…ç”¨æˆ¶é»æ“Šé€£ç·š
                setStatus(false);
                updateUIPanels(radio.value);
                renderContactList();
                renderCurrentChat();
            });
        });

        // ç›£è½é»å°é»èŠå¤©ç™¼é€æŒ‰éˆ•
        sendChatBtn.addEventListener('click', () => {
            const message = chatInput.value.trim();
            const receiverId = currentPeerId; // å¾ç•¶å‰é¸ä¸­çš„è¯ç¹«äººå–å¾— ID

            if (!socket || socket.disconnected) {
                // å˜—è©¦å°‡éŒ¯èª¤å¯«å…¥ç³»çµ±è¨Šæ¯
                addChatMessage({
                    senderId: 'System', 
                    message: `[ç™¼é€å¤±æ•—] é€£ç·šä¸­æ–·ï¼Œè¨Šæ¯ "${message.substring(0, 10)}..." ç„¡æ³•ç™¼é€ã€‚è«‹å…ˆé»æ“Šã€Œé€£ç·š / é‡æ–°è¨»å†Šã€æŒ‰éˆ•å»ºç«‹é€£ç·šã€‚`, 
                    timestamp: new Date().getTime(), 
                    isSystem: true
                });
                selectPeer('System'); // åˆ‡æ›åˆ°ç³»çµ±è¨Šæ¯æé†’ç”¨æˆ¶
                return;
            }

            if (!message) {
                // è¨Šæ¯å…§å®¹ç‚ºç©º
                console.log('è¨Šæ¯å…§å®¹ä¸èƒ½ç‚ºç©ºã€‚');
                return;
            }
            
            if (!receiverId || receiverId === 'System') {
                // æ²’æœ‰é¸ä¸­è¯ç¹«äººæˆ–é¸ä¸­äº†ç³»çµ±è¨Šæ¯
                addChatMessage({
                    senderId: 'System', 
                    message: `[ç™¼é€å¤±æ•—] è«‹åœ¨å·¦å´åˆ—è¡¨é¸å–ä¸€ä½è¯ç¹«äººä¾†ç™¼é€è¨Šæ¯ã€‚`, 
                    timestamp: new Date().getTime(), 
                    isSystem: true
                });
                selectPeer('System'); // åˆ‡æ›åˆ°ç³»çµ±è¨Šæ¯æé†’ç”¨æˆ¶
                return;
            }

            if (message && receiverId && receiverId !== 'System') {
                const data = {
                    senderId: currentUserId,
                    receiverId: receiverId, 
                    message: message,
                    timestamp: new Date().getTime()
                };
                
                // 1. ç™¼é€çµ¦ä¼ºæœå™¨
                socket.emit('send_chat_message', data);

                // 2. å­˜å…¥æ­·å²è¨˜éŒ„ä¸¦é‡æ–°æ¸²æŸ“ç›®å‰å°è©± (æœƒè‡ªå‹•åŸ·è¡Œ addChatMessage)
                addChatMessage(data);

                chatInput.value = ''; // æ¸…ç©ºè¼¸å…¥æ¡†
            }
        });
        
        // å…è¨±æŒ‰ Enter ç™¼é€è¨Šæ¯
        chatInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !sendChatBtn.disabled) { // ç¢ºä¿æŒ‰éˆ•å•Ÿç”¨æ™‚æ‰å…è¨± Enter
                e.preventDefault();
                sendChatBtn.click();
            }
        });


        // ç›£è½å…¬å‘Šç™¼å¸ƒæŒ‰éˆ• (ä½¿ç”¨ Express API)
        broadcastBtn.addEventListener('click', async () => {
            const message = announcementInput.value.trim();
            const target = targetRoleSelect.value;

            if (!message) {
                console.log('è«‹è¼¸å…¥å…¬å‘Šå…§å®¹ã€‚');
                return;
            }

            try {
                const response = await axios.post(`${API_SERVER_URL}/api/broadcast`, {
                    senderId: currentUserId,
                    senderRole: currentUserRole,
                    target: target,
                    message: message
                });

                if (response.data.success) {
                    addAnnouncement('ç³»çµ±æç¤º', `å…¬å‘Šå·²æˆåŠŸç™¼é€çµ¦ ${target}ã€‚`, new Date().getTime());
                    announcementInput.value = '';
                } else {
                    addAnnouncement('ç³»çµ±éŒ¯èª¤', `ç™¼å¸ƒå¤±æ•—: ${response.data.message}`, new Date().getTime());
                }

            } catch (error) {
                console.error('å»£æ’­ API å‘¼å«å¤±æ•—:', error);
                addAnnouncement('ç³»çµ±éŒ¯èª¤', `å»£æ’­å‘¼å«å¤±æ•—ï¼Œè«‹æª¢æŸ¥å¾Œç«¯ä¼ºæœå™¨æ˜¯å¦é‹è¡Œï¼Œæˆ–æ¬Šé™æ˜¯å¦è¶³å¤ ã€‚`, new Date().getTime());
            }
        });

        // ç›£è½è¨‚å–®ç‹€æ…‹æ›´æ–°æŒ‰éˆ• (ä½¿ç”¨ Express API)
        updateStatusBtn.addEventListener('click', async () => {
            const orderId = orderIdInput.value;
            const newStatus = newStatusSelect.value;
            
            if (!orderId || isNaN(parseInt(orderId))) {
                 console.log('è«‹è¼¸å…¥æœ‰æ•ˆçš„è¨‚å–® IDã€‚');
                 return;
            }

            try {
                 const response = await axios.post(`${API_SERVER_URL}/api/order/status`, {
                    senderId: currentUserId,
                    senderRole: currentUserRole,
                    orderId: parseInt(orderId),
                    newStatus: newStatus
                });

                if (response.data.success) {
                    addAnnouncement('ç³»çµ±æç¤º', `è¨‚å–® #${orderId} ç‹€æ…‹æ›´æ–°æ¨æ’­æˆåŠŸ: ${newStatus}ã€‚`, new Date().getTime());
                } else {
                    addAnnouncement('ç³»çµ±éŒ¯èª¤', `è¨‚å–®ç‹€æ…‹æ›´æ–°å¤±æ•—: ${response.data.message}`, new Date().getTime());
                }

            } catch (error) {
                console.error('è¨‚å–®ç‹€æ…‹ API å‘¼å«å¤±æ•—:', error);
                addAnnouncement('ç³»çµ±éŒ¯èª¤', `è¨‚å–®ç‹€æ…‹æ›´æ–°å‘¼å«å¤±æ•—ï¼Œè«‹æª¢æŸ¥å¾Œç«¯ã€‚`, new Date().getTime());
            }
        });
        
        // ç›£è½è¨‚å–® ID è¼¸å…¥æ¡†çš„è®ŠåŒ–ï¼Œå³æ™‚æ›´æ–°æŒ‰éˆ•æ–‡å­—
        orderIdInput.addEventListener('input', () => {
            updateStatusBtn.textContent = `æ›´æ–°è¨‚å–® #${orderIdInput.value || '?'} ç‹€æ…‹`;
        });

        // åˆå§‹ UI è¨­ç½®
        updateUIPanels('student');
        renderContactList();
        renderCurrentChat();
    </script>
</body>
</html>